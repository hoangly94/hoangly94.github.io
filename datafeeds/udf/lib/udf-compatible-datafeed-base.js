import{getErrorMessage,logMessage}from"./helpers";import{HistoryProvider}from"./history-provider";import{DataPulseProvider}from"./data-pulse-provider";import{QuotesPulseProvider}from"./quotes-pulse-provider";import{SymbolsStorage}from"./symbols-storage";function extractField(e,t,s){const r=e[t];return Array.isArray(r)?r[s]:r}export class UDFCompatibleDatafeedBase{constructor(e,t,s,r=1e4){this._configuration=defaultConfiguration(),this._symbolsStorage=null,this._datafeedURL=e,this._requester=s,this._historyProvider=new HistoryProvider(e,this._requester),this._quotesProvider=t,this._dataPulseProvider=new DataPulseProvider(this._historyProvider,r),this._quotesPulseProvider=new QuotesPulseProvider(this._quotesProvider),this._configurationReadyPromise=this._requestConfiguration().then((e=>{null===e&&(e=defaultConfiguration()),this._setupWithConfiguration(e)}))}onReady(e){this._configurationReadyPromise.then((()=>{e(this._configuration)}))}getQuotes(e,t,s){this._quotesProvider.getQuotes(e).then(t).catch(s)}subscribeQuotes(e,t,s,r){this._quotesPulseProvider.subscribeQuotes(e,t,s,r)}unsubscribeQuotes(e){this._quotesPulseProvider.unsubscribeQuotes(e)}getMarks(e,t,s,r,o){if(!this._configuration.supports_marks)return;const i={symbol:e.ticker||"",from:t,to:s,resolution:o};this._send("marks",i).then((e=>{if(!Array.isArray(e)){const t=[];for(let s=0;s<e.id.length;++s)t.push({id:extractField(e,"id",s),time:extractField(e,"time",s),color:extractField(e,"color",s),text:extractField(e,"text",s),label:extractField(e,"label",s),labelFontColor:extractField(e,"labelFontColor",s),minSize:extractField(e,"minSize",s)});e=t}r(e)})).catch((e=>{logMessage(`UdfCompatibleDatafeed: Request marks failed: ${getErrorMessage(e)}`),r([])}))}getTimescaleMarks(e,t,s,r,o){if(!this._configuration.supports_timescale_marks)return;const i={symbol:e.ticker||"",from:t,to:s,resolution:o};this._send("timescale_marks",i).then((e=>{if(!Array.isArray(e)){const t=[];for(let s=0;s<e.id.length;++s)t.push({id:extractField(e,"id",s),time:extractField(e,"time",s),color:extractField(e,"color",s),label:extractField(e,"label",s),tooltip:extractField(e,"tooltip",s)});e=t}r(e)})).catch((e=>{logMessage(`UdfCompatibleDatafeed: Request timescale marks failed: ${getErrorMessage(e)}`),r([])}))}getServerTime(e){this._configuration.supports_time&&this._send("time").then((t=>{const s=parseInt(t);isNaN(s)||e(s)})).catch((e=>{logMessage(`UdfCompatibleDatafeed: Fail to load server time, error=${getErrorMessage(e)}`)}))}searchSymbols(e,t,s,r){if(this._configuration.supports_search){const o={limit:30,query:e.toUpperCase(),type:s,exchange:t};this._send("search",o).then((e=>{if(void 0!==e.s)return logMessage(`UdfCompatibleDatafeed: search symbols error=${e.errmsg}`),void r([]);r(e)})).catch((t=>{logMessage(`UdfCompatibleDatafeed: Search symbols for '${e}' failed. Error=${getErrorMessage(t)}`),r([])}))}else{if(null===this._symbolsStorage)throw new Error("UdfCompatibleDatafeed: inconsistent configuration (symbols storage)");this._symbolsStorage.searchSymbols(e,t,s,30).then(r).catch(r.bind(null,[]))}}resolveSymbol(e,t,s,r){logMessage("Resolve requested");const o=r&&r.currencyCode,i=r&&r.unitId,a=Date.now();function n(e){logMessage(`Symbol resolved: ${Date.now()-a}ms`),t(e)}if(this._configuration.supports_group_request){if(null===this._symbolsStorage)throw new Error("UdfCompatibleDatafeed: inconsistent configuration (symbols storage)");this._symbolsStorage.resolveSymbol(e,o,i).then(n).catch(s)}else{const t={symbol:e};void 0!==o&&(t.currencyCode=o),void 0!==i&&(t.unitId=i),this._send("symbols",t).then((e=>{void 0!==e.s?s("unknown_symbol"):n(e)})).catch((e=>{logMessage(`UdfCompatibleDatafeed: Error resolving symbol: ${getErrorMessage(e)}`),s("unknown_symbol")}))}}getBars(e,t,s,r,o){this._historyProvider.getBars(e,t,s).then((e=>{r(e.bars,e.meta)})).catch(o)}subscribeBars(e,t,s,r,o){this._dataPulseProvider.subscribeBars(e,t,s,r)}unsubscribeBars(e){this._dataPulseProvider.unsubscribeBars(e)}_requestConfiguration(){return this._send("config").catch((e=>(logMessage(`UdfCompatibleDatafeed: Cannot get datafeed configuration - use default, error=${getErrorMessage(e)}`),null)))}_send(e,t){return this._requester.sendRequest(this._datafeedURL,e,t)}_setupWithConfiguration(e){if(this._configuration=e,void 0===e.exchanges&&(e.exchanges=[]),!e.supports_search&&!e.supports_group_request)throw new Error("Unsupported datafeed configuration. Must either support search, or support group request");!e.supports_group_request&&e.supports_search||(this._symbolsStorage=new SymbolsStorage(this._datafeedURL,e.supported_resolutions||[],this._requester)),logMessage(`UdfCompatibleDatafeed: Initialized with ${JSON.stringify(e)}`)}}function defaultConfiguration(){return{supports_search:!1,supports_group_request:!0,supported_resolutions:["1","5","15","30","60","1D","1W","1M"],supports_marks:!1,supports_timescale_marks:!1}}