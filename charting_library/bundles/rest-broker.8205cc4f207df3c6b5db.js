(window.webpackJsonp=window.webpackJsonp||[]).push([["rest-broker"],{"/udZ":function(t,e,s){"use strict";s.d(e,"b",(function(){return o})),s.d(e,"c",(function(){return n})),s.d(e,"a",(function(){return a}));var r=s("25b6"),i=s("YFKU");function o(t){if(void 0===t)return Object(i.t)("Unknown error");let e;return e=t instanceof Error?t.message:"object"==typeof t?JSON.stringify(t):t.toString(),Object(r.d)(e)}function n(t){return t instanceof a?Object(r.d)(t.detailedErrorMessage):o(t)}class a extends Error{constructor({detailedErrorMessage:t,userFriendlyMessage:e}){super(e),this.name="UserFriendlyError",this.detailedErrorMessage=t,Object.setPrototypeOf(this,a.prototype)}}},"0W4x":function(t,e,s){"use strict";s.d(e,"b",(function(){return y})),s.d(e,"h",(function(){return b})),s.d(e,"l",(function(){return P})),s.d(e,"i",(function(){return S})),s.d(e,"c",(function(){return T})),s.d(e,"d",(function(){return v})),s.d(e,"f",(function(){return k})),s.d(e,"k",(function(){return w})),s.d(e,"a",(function(){return F})),s.d(e,"g",(function(){return A})),s.d(e,"e",(function(){return x})),s.d(e,"j",(function(){return q}));var r=s("YFKU"),i=s("ivNn"),o=s("nc0P"),n=s("JES+"),a=s("EBrf"),c=s("ogJP"),u=s("txPx"),l=s("/udZ");const h={},d={},p={},_={};let g=!1;const m=Object(u.getLogger)("Trading.Utils");function f(t){const e={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(t).replace(/[!'()~]|%20|%00/g,(t=>e[t]))}function y(t){const e=[];return t&&Object.keys(t).forEach((s=>{e.push(f(s)+"="+f(t[s]))})),e.join("&")}function b(t){return O(),_[t]}function O(){g||(g=!0,h[2]=$.t("Market"),h[1]=$.t("Limit"),h[3]=$.t("Stop",{context:"order"}),h[4]=$.t("StopLimit"),d[1]=$.t("Buy",{context:"trading"}),d[-1]=$.t("Sell",{context:"trading"}),p[1]=$.t("Long",{context:"trading"}),p[-1]=$.t("Short",{context:"trading"}),_[2]=$.t("filled"),_[1]=$.t("cancelled"),_[6]=$.t("working"),_[3]=$.t("inactive"),_[4]=$.t("placing"),_[5]=$.t("rejected"))}function P(t,e){O();const s=d[t];return e?s.toUpperCase():s}function S(t,e){return O(),e?h[t].toUpperCase():h[t]}function T(t,e,s,r,i){const o={added:[],modified:[],removed:[]},n=t.slice(0);return e.forEach((e=>{const a=t.findIndex((t=>t[s]===e[s]));if(-1===a)return void o.added.push(e);n[a]=null;const u=t[a];for(const t of r){let s=!0;if(null===u[t]||"object"!=typeof u[t]?s=u[t]===e[t]:i&&(s=Object(c.deepEquals)(u[t],e[t])[0]),!s)return void o.modified.push(e)}})),n.forEach((t=>{t&&o.removed.push(t)})),o}function v(t){return Math.abs(t||0)<.001?"0.00":Object(a.splitThousands)((t||0).toFixed(2))}function k(t){return-1!==Object.keys(n.OrderOrPositionMessageType).map((t=>n.OrderOrPositionMessageType[t])).indexOf(t)}function w(t,e,s,r){let o=0;const n=Object(i.fixComputationError)(t/e);return(1===s&&1===r||2===s&&-1===r)&&(o=Math.floor(n)*e),(1===s&&-1===r||2===s&&1===r)&&(o=Math.ceil(n)*e),Object(i.fixComputationError)(o)}const C=Object(r.t)("Failed to login");class F{constructor(t){this._isFinished=!1,this._isTerminated=!1,this._tasks=t}execute(){return this._isTerminated=!1,this._isExecuted()&&!this._isFinished?this.terminate().then((()=>this._execution=this._execute())):this._execution=this._execute()}async terminate(){if(this._isExecuted()&&!this._isFinished){this._isTerminated=!0;try{await this._execution}catch(t){return void m.logWarn(t)}}}_isExecuted(){return!!this._execution}async _execute(){for(const t of this._tasks){if(this._isTerminated)throw new Error("Login tasks are terminated");try{await t()}catch(t){throw this._isFinished=!0,new l.a({detailedErrorMessage:`${C}${j(Object(l.c)(t))}`,userFriendlyMessage:`${C}${j(Object(l.b)(t))}`})}}this._isFinished=!0}}function j(t){return void 0===t||""===t?"":": "+t}function A(t){return(new o.Big(t).toFixed().split(".")[1]||"").length}function x(t){return-1!==[2,1,5].indexOf(t)}function q(t){return O(),p[t]}},"14a3":function(t,e,s){"use strict";var r=s("3+Gi");s.d(e,"c",(function(){return r.a}));var i=s("JES+");s.d(e,"a",(function(){return i.AccountType})),s.d(e,"b",(function(){return i.DisconnectType})),s("25b6")},"24R9":function(t,e,s){"use strict";function r(t){return decodeURIComponent(t.replace(/\+/g," ")).replace(/<\/?[^>]+(>|$)/g,"")}function i(){return function(t){const e=/([^&=]+)=?([^&]*)/g,s={};if(!t)return s;let i=e.exec(t);for(;i;)s[r(i[1])]=r(i[2]),i=e.exec(t);return s}(window.location.search.substring(1))}function o(t){const e=[];for(const s in t)t.hasOwnProperty(s)&&null!=t[s]&&e.push({key:s,pair:encodeURIComponent(s)+"="+encodeURIComponent(t[s])});return e.sort(((t,e)=>t.key>e.key?1:t.key<e.key?-1:0)).map((t=>t.pair)).join("&")}s.d(e,"b",(function(){return i})),s.d(e,"a",(function(){return o}))},"3+Gi":function(t,e,s){"use strict";var r;s.d(e,"a",(function(){return r})),function(t){t[t.StopLoss=0]="StopLoss",t[t.TrailingStop=1]="TrailingStop"}(r||(r={}))},E9hm:function(t,e,s){"use strict";s.r(e),s.d(e,"defaultConfigFlags",(function(){return r})),s.d(e,"applyDefaultsToConfigFlags",(function(){return i}));const r={isSuspended:!1,supportDemoLiveSwitcher:!0,supportEditAmount:!0,supportMarketBrackets:!0,supportMarketOrders:!0,supportStopOrders:!0,supportLimitOrders:!0,supportStopLimitOrders:!1,supportPositions:!0,supportDOM:!0,supportModifyOrder:!0,supportModifyTrailingStop:!0,supportAddBracketsToExistingOrder:!0,supportVerifyLiveAccount:!0,supportReversePosition:!0,showNotificationsLog:!0,supportTwoFactorAuthorization:!1,supportDisplayBrokerNameInSymbolSearch:!0};function i(t){return Object.assign({},r,t)}},EBrf:function(t,e,s){"use strict";s.r(e),s.d(e,"splitThousands",(function(){return i}));var r=s("ivNn");function i(t,e="&nbsp;"){let s=t+"";-1!==s.indexOf("e")&&(s=function(t){return Object(r.fixComputationError)(t).toFixed(10).replace(/\.?0+$/,"")}(Number(t)));const i=s.split(".");return i[0].replace(/\B(?=(\d{3})+(?!\d))/g,e)+(i[1]?"."+i[1]:"")}},LRNa:function(t,e,s){"use strict";s.r(e);var r=s("YFKU"),i=s("Eyy1"),o=s("ivNn"),n=(s("bSeV"),s("14a3"));const a=[{label:Object(r.t)("Symbol"),formatter:"symbol",property:"brokerSymbol",notHideable:!0},{label:Object(r.t)("Side"),property:"side",formatter:"side"},{label:Object(r.t)("Type"),property:"type",formatter:"type"},{label:Object(r.t)("Qty"),alignment:"right",property:"qty",formatter:"formatQuantity",help:Object(r.t)("Size in lots")},{label:Object(r.t)("Filled Qty"),alignment:"right",property:"filledQty",formatter:"formatQuantity",help:Object(r.t)("Filled Size in lots")},{label:Object(r.t)("Limit Price"),alignment:"right",property:"limitPrice",formatter:"formatPrice"},{label:Object(r.t)("Stop Price"),alignment:"right",property:"stopPrice",formatter:"formatPrice"},{label:Object(r.t)("Take Profit"),alignment:"right",property:"takeProfit",formatter:"formatPrice"},{label:Object(r.t)("Stop Loss"),alignment:"right",property:"stopLoss",formatter:"formatPrice"},{label:Object(r.t)("Avg Fill Price"),alignment:"right",property:"avgPrice",formatter:"formatPrice",supportedStatusFilters:[0,6,2]},{id:"status",label:Object(r.t)("Status"),property:"status",formatter:"status",supportedStatusFilters:[0]},{label:Object(r.t)("Update Time"),property:"updateTime",formatter:"localDate"},{label:Object(r.t)("Order id"),property:"id"},{label:Object(r.t)("Expiry"),property:"expiry"},{label:Object(r.t)("Expiry Time"),alignment:"right",property:"expiryTime",formatter:"localDateOrDateTime"}],c=[{label:Object(r.t)("Symbol"),formatter:"symbol",property:"brokerSymbol",notHideable:!0},{label:Object(r.t)("Side"),property:"side",formatter:"side"},{label:Object(r.t)("Type"),property:"type",formatter:"type"},{label:Object(r.t)("Qty"),alignment:"right",property:"qty",formatter:"formatQuantity",help:Object(r.t)("Size in lots")},{label:Object(r.t)("Filled Qty"),alignment:"right",property:"filledQty",formatter:"formatQuantity",help:Object(r.t)("Filled Size in lots")},{label:Object(r.t)("Limit Price"),alignment:"right",property:"limitPrice",formatter:"formatPrice"},{label:Object(r.t)("Stop Price"),alignment:"right",property:"stopPrice",formatter:"formatPrice"},{label:Object(r.t)("Take Profit"),alignment:"right",property:"takeProfit",formatter:"formatPriceForexSup"},{label:Object(r.t)("Stop Loss"),alignment:"right",property:"stopLoss",formatter:"formatPriceForexSup"},{label:Object(r.t)("Avg Fill Price"),alignment:"right",property:"avgPrice",formatter:"formatPrice"},{id:"status",label:Object(r.t)("Status"),property:"status",formatter:"status"},{label:Object(r.t)("Update Time"),property:"updateTime",formatter:"localDate"},{label:Object(r.t)("Order id"),property:"id"}],u=(Object(r.t)("Balance"),Object(r.t)("Equity",{context:"trading"}),Object(r.t)("Total Profit"),[{label:Object(r.t)("Symbol"),formatter:"symbol",property:"brokerSymbol",notHideable:!0},{label:Object(r.t)("Side"),property:"side",formatter:"positionSide"},{label:Object(r.t)("Qty"),alignment:"right",property:"qty",formatter:"formatQuantity",help:Object(r.t)("Size in lots")},{label:Object(r.t)("Avg Fill Price"),alignment:"right",property:"avgPrice",formatter:"avgPriceFormatter"},{label:Object(r.t)("Take Profit"),alignment:"right",property:"takeProfit",formatter:"formatPriceForexSup"},{label:Object(r.t)("Stop Loss"),alignment:"right",property:"stopLoss",formatter:"formatPriceForexSup"},{label:Object(r.t)("Profit"),alignment:"right",property:"unrealizedPl",formatter:"profitInInstrumentCurrency",fixedWidth:!0},{label:Object(r.t)("Position id"),property:"id"}]),l=[{label:Object(r.t)("Symbol"),property:"symbol"},{label:Object(r.t)("Currency name"),property:"longName",notSortable:!0},{label:Object(r.t)("Total"),alignment:"right",property:"total",formatter:"variablePrecision",fixedWidth:!0},{label:Object(r.t)("Available"),alignment:"right",property:"available",formatter:"variablePrecision",fixedWidth:!0},{label:Object(r.t)("Reserved"),alignment:"right",property:"reserved",formatter:"variablePrecision",fixedWidth:!0},{label:Object(r.t)("BTC value"),alignment:"right",property:"btcValue",formatter:"variablePrecision",fixedWidth:!0},{label:Object(r.t)("Value"),property:"value",alignment:"right",formatter:"cryptoValueInCurrencyFormatter",fixedWidth:!0}];var h=s("0W4x"),d=s("/udZ"),p=s("24R9");s("bZMm");const _=window.t("Failed to fetch");var g;function m(t){const e={Accept:"application/json","Content-Type":"application/x-www-form-urlencoded",Referer:"https://www.tradingview.com/chart/OlHDdzUm/"};return t&&(e.Authorization="Bearer "+t),e}async function f(t,e,s=g.Get,r,i){const o=await async function(t,e,s=g.Get,r,i){const o=await async function(t,e,s=g.Get,r,i){const o=r?Object(p.a)(r):r,n={method:g[s],headers:m(e)};o&&s!==g.Get&&(n.body=o);try{const e=await fetch(t,n);if(!e.ok)throw new Error(e.statusText);return e}catch(t){throw t.message=Object(d.b)(t),i&&i.logError(t.message),t}}(t,e,s,r,i),n=await o.json();if(!function(t){return!(!t||t.hasOwnProperty("s")&&"error"===t.s)}(n)){const t=n.errmsg?n.errmsg:_;throw i&&i.logError(t),new Error(t)}return n}(t,e,s,r,i);return"d"in o?o.d:o}function y(t,e){return{login:t,password:e,locale:window.locale}}function b(t){return{valid:!0,data:t}}async function O(t,e,s,r,i=b,o){const n={method:g[e],headers:s};try{null!==r&&(n.body=JSON.stringify(r));const e=await fetch(t,n);if(!e.ok){if(void 0!==o){const t=await o(e);throw new d.a({detailedErrorMessage:t.logMessage,userFriendlyMessage:t.userFriendlyMessage})}throw new Error(e.statusText)}const s=i(await e.json());if(!1===s.valid)throw new Error(s.errormsg);return s.data}catch(t){throw new d.a({detailedErrorMessage:t.message,userFriendlyMessage:t.userFriendlyMessage})}}!function(t){t[t.Get=1]="Get",t[t.Post=2]="Post",t[t.Put=3]="Put",t[t.Delete=4]="Delete"}(g||(g={}));var P=s("e3/o"),S=s("txPx"),T=s("aIyQ"),v=s.n(T);const k=Object(S.getLogger)("Trading.Requester");class w{constructor(t,e,s,r,i,o,n){this._currentPulseIndex=0,this._requestInterval=null,this._requestTimeOut=null,this._errorsCount=0,this._status=0,this._snapshot=!0,this._url=t,this._headers=s,this._method=e,this._body=r,this._requestInterval=i,this.update=new v.a,this.statusChanged=new v.a,this._extractResponseData=o,this._extractErrorMessage=n}start(){return this._status=1,this._errorsCount=0,this._currentPulseIndex++,this._request()}stop(){this._status=0,this._clearResetRequestTimeout()}pause(){this.stop()}unpause(){this.start()}status(){return this._status}changeUrl(t){Object(i.assert)(1!==this._status,"Cannot change URL: requester is running"),this._url=t}changeHeaders(t){Object(i.assert)(1!==this._status,"Cannot change headers: requester is running"),this._headers=t}async _request(){const t=this._currentPulseIndex;Object(i.assert)(1===this._status,"Unable to request: requester is inactive");try{const e=this._url,s=await O(this._url,this._method,this._headers,this._body,this._extractResponseData,this._extractErrorMessage);this._errorsCount=0,e===this._url&&1===this._status&&t===this._currentPulseIndex&&(this.update.fire(s,this._snapshot),this._snapshot=!1)}catch(e){k.logError(`${Object(d.c)(e)}: ${this._url}`),this._errorsCount++,t===this._currentPulseIndex&&this._failOnErrorsCount(Object(d.b)(e))}finally{null!==this._requestInterval&&1===this._status&&t===this._currentPulseIndex&&await this._makeNextRequest()}}_clearResetRequestTimeout(){null!==this._requestTimeOut&&(clearTimeout(this._requestTimeOut),this._requestTimeOut=null)}_failOnErrorsCount(t){this._errorsCount>20&&(this._clearResetRequestTimeout(),this._status=2,this.statusChanged.fire({requesterStatus:this._status,errorMessage:t}))}async _makeNextRequest(){const t=this._currentPulseIndex;this._requestTimeOut=null,this._requestTimeOut=setTimeout((async()=>{t===this._currentPulseIndex&&await this._request()}),this._requestInterval)}}class C{constructor(t,e,s,r,i,o,n,a,c,u){this.update=new v.a,this.statusChanged=new v.a,this._data=[],this._status=0,this._requester=new w(t,e,s,r,i,a,c),this._idField=o,this._keys=n,this._useDeepEquals=u}start(){return this._status=1,this._requester.update.subscribe(this,this._onNewData),this._requester.statusChanged.subscribe(this,this._onStatusChanged),this._requester.start()}stop(){this._status=0,this._requester.update.unsubscribe(this,this._onNewData),this._requester.statusChanged.unsubscribe(this,this._onStatusChanged),this._requester.stop(),delete this._requester}pause(){this._status=0,this._requester.stop()}unpause(){this._status=1,this._requester.start()}changeHeaders(t){this._requester.changeHeaders(t)}_onNewData(t,e){if(1!==this._status)return;const s=Object(h.c)(this._data,t,this._idField,this._keys,this._useDeepEquals);(s.added.length>0||s.modified.length>0||s.removed.length>0)&&(this._data=t,this.update.fire(s,e))}_onStatusChanged(t){this._status=t.requesterStatus,this.statusChanged.fire({requesterStatus:t.requesterStatus,errorMessage:t.errorMessage})}}var F=s("G3Rl");s.d(e,"Broker",(function(){return Y}));const j={limit:1,market:2,stop:3,stoplimit:4},A={1:"limit",2:"market",3:"stop",4:"stoplimit"},x={placing:4,inactive:3,working:6,rejected:5,filled:2,cancelled:1},q=["qty","status","filledQty","avgPrice","limitPrice","stopPrice","parentId","duration","customFields","message"],D=["instrument","qty","side","avgPrice","unrealizedPl","realizedPl","stopLoss","takeProfit"],I=["available","total","btcValue"],R={checked:!1,text:""},B={history:500,positions:1e3,quotes:500,orders:500,accountManager:500,balances:1e3},U=Object(r.t)("This market is not tradable with this brokerage account. Switch to another account and try again"),E=Object(r.t)("You can't trade this market with this brokerage account. Please switch over to a different market and have another try.");function M(t){return t.s&&"ok"!==t.s?{valid:!1,errormsg:t.errmsg}:{valid:!0,data:t.d}}function z(t){return j[t=t||"market"]}function V(t){return"sell"===t?-1:1}function L(t){return void 0!==t.accountManager&&Array.isArray(t.accountManager)&&t.accountManager.length>0}function $(t){return t.amData&&Array.isArray(t.amData)&&t.amData.length>0?t.amData:function(t){const e=Object(h.d)(t.balance),s=Object(h.d)(t.unrealizedPl);return[[[e,void 0!==t.equity?Object(h.d)(t.equity):Object(h.d)(t.balance+t.unrealizedPl),s]]]}(t)}function Q(t,e){const s=2!==e.status&&1!==e.status,r=s?e.limitPrice:void 0,i=s?e.stopPrice:void 0;3===e.type?t.stopLoss=i:t.takeProfit=r}function W(t){return t.map((t=>({price:t[0],volume:t[1]})))}function H(t){return Object.assign({id:t.symbol},t)}function G(t){return t.map((t=>{const e=!t.mutable;return delete t.mutable,Object.assign(Object.assign({},t),{inputType:"ComboBox",preventModify:e})}))}function N(t,e){return e.filter((e=>!(e in t)))}const K=Object(r.t)("Accounts configuration is invalid"),J=Object(r.t)("Broker configuration is invalid");class Y{constructor(t,e,s,r=null,o){var c;if(this._accounts=[],this._accountManagerTablesData=[],this._accountManagerTablesDelegates=[],this._fetchedBrokerSymbols=new Set,this._cryptoBalances=[],this._oAuthAuthorizationProvider=null,this._requesters={},this._depthSubscriptions={},this._customFormatters=[],this._permittedSymbolSearchGroups=[],this._accessTokenExpirationTimeout=null,this._loginTasks=null,this._orderColumns=a,this._positionColumns=u,this._makeInstrumentOrderDialogCustomFieldsMemoized=Object(F.a)(this._makeInstrumentOrderDialogCustomFields,(t=>t.concat(this.currentAccount()))),this._makeAccountOrderDialogCustomFieldsMemoized=Object(F.a)(this._makeAccountOrderDialogCustomFields,(()=>this.currentAccount())),this._reconnectOnFailCount=1,this._host=t,this._fastRenewOauthToken=o,this._restUrl=c="/"===(c=e)[c.length-1]?c:c+"/",this._metainfo=s,this._realtimeSubscriptions=new Set,this._pipValueSubscriptions=new Set,this._quotesSubscriptions=new Map,this._currentQuotes=new Map,this._priceFormatterCache=new Map,this._instruments=new Map,this._initData(),this._tokenStorageKey=String("rest-token"),this._permittedSymbolSearchGroups=[Object(i.ensureDefined)(s.id)],this._lastAccountIdKey=String("rest-last-account-id-"+s.id),this._logger=t.getLogger(),this._status=this._host.factory.createWatchedValue(3),this._account=t.factory.createWatchedValue({id:"",name:"",currencySign:"",config:{},instruments:[],type:n.a.Demo}),this._createMapper(),this._setAccountBinded=this._setAccount.bind(this),r){const t=Date.now()+432e6;this._saveAccessToken({access_token:r,expiration:t}),this._setAccessTokenExpirationTimeout(t)}this._createButtonDropdownOptions(),this._customFormatters.push({name:"avgPriceFormatter",format:t=>{const e=this._priceFormatterCache.get(t.row.symbol);return e?e.format(t.value):String(t.value)}},{name:"cryptoValueInCurrencyFormatter",format:t=>`${t.row.value} ${t.row.valueCurrency}`}),this._cryptoBalanceTableChangeDelegate=this._host.factory.createDelegate()}tryRestoreSession(){this._tryRestorePreviousSession()}chartContextMenuActions(t,e){return this._host.defaultContextMenuActions(t,e)}async accountsMetainfo(){return this._accounts}setCurrentAccount(t){const e=this._accounts.find((e=>e.id===t));void 0!==e&&this._account.setValue(e)}accountManagerInfo(){const t=this._accountSummaryRowData.titles.map(((t,e)=>({text:t,wValue:this._accountSummaryRowData.values[e].readonly(),formatter:this._accountSummaryRowData.formatters[e]}))),e=[],s=this._ensuredConfigFlags().supportOrderBrackets||this._ensuredConfigFlags().supportPositionBrackets,o=this._ensuredConfigFlags().supportBalances;if(L(this._brokerConfig))if(o){const t=0!==this._cryptoBalances.length?Object.keys(this._cryptoBalances[0]):l.map((t=>t.property)),s=l.filter((e=>t.includes(e.property))),r=Object.assign({},{id:"cryptoBalances",name:"Balances",getData:()=>Promise.resolve(this._cryptoBalances.map((t=>H(t)))),changeDelegate:this._cryptoBalanceTableChangeDelegate,columns:s});e.push(r)}else{const t=Object(i.ensure)(this._brokerConfig.accountManager).map(((t,e)=>Object.assign({},{id:t.id,title:void 0!==t.title&&t.title.length>0?t.title:Object(r.t)("Account Info"),getData:()=>Promise.resolve(this._accountManagerTablesData[e]),changeDelegate:this._accountManagerTablesDelegates[e],columns:t.columns.map((t=>Object.assign({},{id:t.id,label:t.title,help:t.tooltip,property:t.id,formatter:t.formatter,notSortable:!t.sortable,fixedWidth:t.fixedWidth,tooltip:t.tooltip})))})));e.push(...t)}const n=Object(i.ensureDefined)(this._metainfo),a=this._brokerConfig.durations&&this._brokerConfig.durations.some((t=>Boolean(t.hasDatePicker||t.hasTimePicker))),u=t=>s||"stopLoss"!==t.property&&"takeProfit"!==t.property,h=void 0!==n.customPositionColumnTitles&&n.customPositionColumnTitles.length>0?this._positionColumns.map((t=>{const e=Object(i.ensureDefined)(n.customPositionColumnTitles).find((e=>void 0!==t.property&&e.hasOwnProperty(t.property)));return t.label=void 0!==e?e[Object(i.ensureDefined)(t.property)]:t.label,t})):this._positionColumns,d={accountTitle:Object(i.ensure)(this._metainfo.title),orderColumns:this._orderColumns.filter(u).filter((t=>this._brokerConfig.durations||"expiry"!==t.property)).filter((t=>a||"expiryTime"!==t.property)).filter((t=>this._ensuredConfigFlags().supportPartialOrderExecution||"filledQty"!==t.property)),pages:[{id:"summary",title:Object(r.t)("Account Summary"),tables:e}],positionColumns:h.filter(u).filter((t=>this._ensuredConfigFlags().supportMultiposition||"id"!==t.property)),summary:t,customFormatters:this._customFormatters};return this._ensuredConfigFlags().supportOrdersHistory&&(d.historyColumns=c.filter(u)),d}currentAccount(){return this._account.value().id}currentAccountType(){return 0!==this._accounts.length?this._accounts.some((t=>t.type===n.a.Live))?n.a.Live:n.a.Demo:void 0}async executions(t){const e=this._mapFromTV(t);return null!==e&&!1===this._fetchedBrokerSymbols.has(e)&&await this._requestExecutions(e),this._tvExecutions.filter((e=>e.symbol===t))}orders(){return Promise.resolve(this._tvOrders)}async ordersHistory(){const t=await this._getOrdersHistoryByAccountId(this._account.value().id);return Promise.resolve(t.map((t=>this._orderToTV(t))))}positions(){return Promise.resolve(this._tvPositions)}async cancelOrder(t){return f(this._getOrderIdRestUrl(t),this._getAccessToken(),g.Delete)}async modifyOrder(t,e){if(2===t.parentType){if(void 0===this._tvPositionById(t.parentId))return;const e=this._getPositionBracketsById(t.parentId);return this.editPositionBrackets(Object(i.ensure)(t.brokerSymbol),{takeProfit:t.limitPrice||e.takeProfit,stopLoss:t.stopPrice||e.stopLoss})}if(1===t.parentType){const s=this._tvOrderById(Object(i.ensure)(t.parentId));return 2!==s.status?this.modifyOrder(Object.assign(Object.assign({},s),{stopLoss:t.stopPrice,takeProfit:t.limitPrice}),e):this._modifySingleOrder(t,e)}return this._modifySingleOrder(t,e)}async placeOrder(t,e){var s;const r=this._ensuredConfigFlags().supportDigitalSignature;let i=null;t.customFields&&r&&(i=((null===(s=t.customFields)||void 0===s?void 0:s.digitalSignature)||this._getDigitalSignatureState()).text,this._setDigitalSignatureState(t.customFields.digitalSignature));const o=Object.assign({},t.customFields);return delete o.digitalSignature,this._placeOrder(t,i,o,e)}async cancelOrders(t,e,s){return(()=>Promise.all(s.map((t=>this.cancelOrder(t)))).then((()=>{})))()}editPositionBrackets(t,e){const s=this._getPositionIdRestUrl(t),r=Object.assign({},e);return f(s,this._getAccessToken(),g.Put,r)}reversePosition(t,e){const s=this._getPositionIdRestUrl(t),r=this._tvPositionById(t);if(void 0===r)throw new Error(`Failed to reverse position: Position ${t} not found`);const i=1===r.side?"sell":"buy",o=Object.assign({side:i},e);return f(s,this._getAccessToken(),g.Put,o)}closePosition(t){return f(this._getPositionIdRestUrl(t),this._getAccessToken(),g.Delete)}async isTradable(t){const e=this._mapFromTV(t);if(null!==e){const t=this._instruments.has(e),s={tradable:t};if(!t){const t=this._getAccountWithTradableSymbol(e);null!==t&&(s.solutions={changeAccount:t.id},s.shortReason=U,s.reason=U)}return s}if(void 0!==this._metainfo.symbolPrefix){const e=t.split(":")[1],s=`${this._metainfo.symbolPrefix}:${e}`,r=this._mapFromTV(s);if(null!==r&&void 0!==this._instruments.get(r))return{tradable:!1,reason:E,shortReason:E,solutions:{changeSymbol:s}}}return{tradable:!1}}subscribeRealtime(t){const e=this._mapFromTV(t);null!==e?(this._realtimeSubscriptions.add(e),this._subscribeQuotes(e)):this._logger.logError("Symbol not found")}unsubscribeRealtime(t){const e=this._mapFromTV(t);null!==e?(this._realtimeSubscriptions.delete(e),this._unsubscribeQuotes(e)):this._logger.logError("Symbol not found")}subscribePipValue(t){const e=this._mapFromTV(t);if(null!==e){if(!this._instrumentInfo(e).hasQuotes)return;this._pipValueSubscriptions.add(e),this._subscribeQuotes(e)}else this._logger.logError("Symbol not found")}unsubscribePipValue(t){const e=this._mapFromTV(t);null!==e?this._pipValueSubscriptions.has(e)&&(this._pipValueSubscriptions.delete(e),this._unsubscribeQuotes(e)):this._logger.logError("Symbol not found")}subscribeDOME(t){const e=this._mapFromTV(t);if(null!==e){const s=this._getDepthUrl(e),r=new w(s,g.Get,this._getHeaders(),null,this._getPullingInterval("quotes"),M),i=this._onDepthUpdate.bind(this,t);r.update.subscribe(this,i),r.start(),this._depthSubscriptions[t]={callback:i,requester:r}}else this._logger.logError("Symbol not found")}unsubscribeDOME(t){try{this._depthSubscriptions[t].requester.update.unsubscribe(this,this._depthSubscriptions[t].callback),this._depthSubscriptions[t].requester.stop(),delete this._depthSubscriptions[t]}catch(t){this._logger.logError(Object(d.c)(t))}}async signIn(t,e,s,o){this._setStatus(2),this._host.credentialsStorage.clear(this._tokenStorageKey);try{let s;if(this._isSimplePasswordAuthorizationType()&&(s=async()=>{const s=await this._authorize(t,e);this._saveAccessToken(s),this._setAccessTokenExpirationTimeout(s.expiration)}),this._isTwoFactorAuthorizationType()){if(void 0===(null==o?void 0:o.verificationCode)){const s=await this._authorizeRequestTwoFactorCode(t,e);if(!("twoFactorMessage"in s))throw new Error(Object(r.t)("Two Factor Authorization is not configured properly"));return void this._setStatus(4,{message:s.twoFactorMessage,disconnectType:n.b.TwoFactorRequired})}s=async()=>{const s=await this._authorizeWithTwoFactorCode(t,e,Object(i.ensureDefined)(o.verificationCode));this._saveAccessToken(s),this._setAccessTokenExpirationTimeout(s.expiration)}}await this._setAndStartLoginTasks(s),this._createButtonDropdownOptions(),this._reconnectOnFailCount=1,this._setStatus(1)}catch(t){this._logger.logError("Failed to connect to broker: "+Object(d.c)(t)),this._setStatus(4,{message:Object(d.b)(t)}),this._disconnect()}}async symbolInfo(t){const e=this._mapFromTV(t);if(null!==e)return this._instrumentInfo(e);throw new Error("Symbol not found")}connectionStatus(){return this._status.value()}async disconnect(t=!1){this._disconnect(t),null!==this._loginTasks&&await this._loginTasks.terminate(),this._setStatus(3,{message:void 0,disconnectType:n.b.LogOut})}supportFloatingPanel(){return!0}getRealtimeDataCheckParams(){return{token:this._getAccessToken()}}getVerifyLiveAccountParams(){return{token:this._getAccessToken()}}unhideSymbolSearchGroups(){return this._permittedSymbolSearchGroups}async formatter(t){return this._getPriceFormatterForSymbol(t)}async spreadFormatter(t){const e=this._mapFromTV(t);if(null!==e){const s=this._instruments.get(e);return void 0===s||"forex"!==s.type&&"cfd"!==s.type?this._host.defaultFormatter(t,!1):this._host.numericFormatter(1)}throw new Error("Symbol not found")}quantityFormatter(t){const e=this._mapFromTV(t);if(null!==e){const t=this._instruments.get(e);if(void 0!==t&&"crypto"===t.type)return this._host.quantityFormatter()}return this._host.quantityFormatter()}async previewOrder(t){const e=this._orderFromTV(t);(function(t){return"id"in t})(t)&&(e.id=t.id);const s=this._getOrderPreviewRestUrl();return void 0!==t.customFields&&Object.assign(e,t.customFields),f(s,this._getAccessToken(),g.Post,e)}async getOrderDialogOptions(t){return{customFields:this._makeOrderDialogCustomFields(t)}}async _updateAccount(t){this._saveAccountId(t),this._account.setValue(t);const e=t.durations?t.durations:this._originalBrokerConfig.durations;this._brokerConfig=Object.assign({},this._originalBrokerConfig,t.ui,{durations:e}),this._metainfo.configFlags=Object.assign(this._metainfo.configFlags,t.config),this._host.patchConfig(Object(i.ensureDefined)(this._metainfo.configFlags)),this._makeAccountSummaryRowData();for(const e of t.instruments)"forex"!==e.type&&"cfd"!==e.type||void 0===e.pipSize||(e.minPriceStep=Object(o.fixComputationError)(10**-Object(h.g)(e.pipSize))),this._instruments.set(e.name,e);await this._initRequesters();const s=await this._getAccountState();for(let t=0;t<Object(i.ensure)(this._brokerConfig.accountManager).length;t++){const t=this._host.factory.createDelegate();this._accountManagerTablesDelegates.push(t),this._accountManagerTablesData.push([{}])}this._setAccountManagerTableData($(s)),this._setAccountSummaryRowData(s),this._brokerConfig.durations&&this._host.setDurations(function(t){const e=[];for(const s of t){const t={name:s.title,value:s.id,hasDatePicker:s.hasDatePicker,hasTimePicker:s.hasTimePicker};void 0!==s.supportedOrderTypes&&(t.supportedOrderTypes=s.supportedOrderTypes.map((t=>z(t)))),"default"in s&&(t.default=s.default),e.push(t)}return e}(this._brokerConfig.durations)),this._changeQuotesRequesterUrl()}async _getAccounts(){const t=await f(this._getAccountsUrl(),this._getAccessToken()),e=this._metainfo.defaultAccountType||n.a.Demo;if(!Array.isArray(t))throw new d.a({detailedErrorMessage:K+": Response is not an array",userFriendlyMessage:K});if(0===t.length)throw new d.a({detailedErrorMessage:K+": Response is empty",userFriendlyMessage:K});for(const s of t){const t=N(s,["id","name","type","config"]);if(0!==t.length)throw new d.a({detailedErrorMessage:K+": Required fields are missing: "+t.join(", "),userFriendlyMessage:K});s.currency=s.currency||"",s.currencySign=s.currencySign||"",s.type=s.type||e}return t}async _setAccount(t){const e=1===this.connectionStatus();this._cleanup(),e&&this._setStatus(2),await this._updateAccount(t),e&&this._setStatus(1)}_setAndStartLoginTasks(t){const e=[];return void 0!==t&&e.push(t),e.push((()=>this._getBrokerConfig().then((t=>{this._originalBrokerConfig=t}))),...this._initializeAccountTasks()),this._loginTasks=new h.a(e),this._loginTasks.execute()}_createOAuthAuthorizationProvider(t){let e;const s={fastRenewOauthToken:this._fastRenewOauthToken,brokerId:Object(i.ensureDefined)(this._metainfo.id),environmentType:t,logger:this._logger,passLocalesLangInOAuth:this._ensuredConfigFlags().passLocalesLangInOAuth};return this._isOAuthImplicitFlowAuthType()?e=new OAuth2ImplicitFlowWithRenewTokenAuthorizationProvider(s):(s.passRedirectUrl=!0,e=new OAuth2CodeFlowAuthorizationProvider(s)),e}_instrumentInfo(t){const e=this._instruments.get(t);if(!e)throw new Error("Instrument not found");const s={qty:{min:e.minQty||1,max:e.maxQty||1e9,step:e.qtyStep||1},pipValue:e.pipValue||1,pipSize:e.pipSize||.01,minTick:e.minTick||.01,description:e.description,brokerSymbol:t,hasQuotes:!e.hasOwnProperty("hasQuotes")||Boolean(e.hasQuotes)};return e.hasOwnProperty("lotSize")&&(s.lotSize=e.lotSize),e.hasOwnProperty("stopPriceStep")&&(s.stopPriceStep=e.stopPriceStep),e.hasOwnProperty("limitPriceStep")&&(s.limitPriceStep=e.limitPriceStep),"type"in e&&(s.type=e.type),"marginRate"in e&&(s.marginRate=e.marginRate),"baseCurrency"in e&&(s.baseCurrency=e.baseCurrency),"quoteCurrency"in e&&(s.quoteCurrency=e.quoteCurrency),s}_subscribeQuotes(t){const e=this._quotesSubscriptions.get(t),s=void 0===e?1:e+1;this._quotesSubscriptions.set(t,s),1===s&&this._changeQuotesRequesterUrl()}_unsubscribeQuotes(t){const e=this._quotesSubscriptions.get(t);if(void 0!==e)return 1===e?(this._quotesSubscriptions.delete(t),void this._changeQuotesRequesterUrl()):void this._quotesSubscriptions.set(t,e-1)}_disconnect(t=!1){this._isOAuthAuthorizationType()&&this._cleanAndDestroyOauthAuthorizationProvider(),this._cleanup(),this._cleanAccessTokenExpirationTimeout(),!1===t&&this._host.credentialsStorage.clear(this._tokenStorageKey),this._account.unsubscribe(this._setAccountBinded)}_getAccessToken(){return this._accessToken}_initializeAccountTasks(){const t=[];return t.push((()=>this._getAccounts().then((t=>{this._accounts=t})))),t.push((()=>Promise.all(this._accounts.map((t=>this._getInstrumentsByAccountId(t.id).then((e=>{t.instruments=e}))))))),this._ensuredConfigFlags().supportUnhideSymbolSearchGroups&&t.push((()=>this._getPermittedSymbolSearchGroups().then((t=>{this._permittedSymbolSearchGroups=t})))),t.push((()=>this._mapper.ready())),t.push((()=>{const t=this._getLastAccount(),e=void 0!==t?t:this._accounts[0];return e.config.supportOrderCustomFields&&this._originalBrokerConfig.orderCustomFields&&(this._orderColumns=this._mergeCustomFieldColumns(a,Object(i.ensureDefined)(this._originalBrokerConfig.orderCustomFields))),e.config.supportPositionCustomFields&&this._originalBrokerConfig.positionCustomFields&&(this._positionColumns=this._mergeCustomFieldColumns(u,Object(i.ensureDefined)(this._originalBrokerConfig.positionCustomFields))),this._setAccountBinded(e).then((()=>this._account.subscribe(this._setAccountBinded)))})),t}_onQuotesUpdate(t){for(const e of t)if("ok"===e.s){const t=e.n,s=this._mapToTV(t);if(null!==s){const r=e.v;r.lp=r.lp||0,r.ch=r.ch||0,r.chp=r.chp||0;const n=this._instruments.get(t);if(void 0===n)throw new Error(`Instrument ${t} not found`);if(("forex"===n.type||"cfd"===n.type)&&void 0!==n.pipSize){const t=Object(i.ensureDefined)(n.minPriceStep);r.spread=Object(o.fixComputationError)((r.ask-r.bid)/t)}r.buyPipValue&&r.sellPipValue&&this._pipValueSubscriptions.has(t)&&(this._host.pipValueUpdate(s,{buyPipValue:r.buyPipValue,sellPipValue:r.sellPipValue}),n.pipValue=r.buyPipValue),this._currentQuotes.set(s,{ask:r.ask,bid:r.bid}),this._host.realtimeUpdate(s,r)}else this._logger.logError("Cannot map symbol")}}_changeQuotesRequesterUrl(){const t=this._getQuotesUrl();void 0!==this._requesters.quotes&&this._requesters.quotes.stop(),null!==t&&(void 0===this._requesters.quotes?(this._requesters.quotes=new w(t,g.Get,this._getHeaders(),null,this._getPullingInterval("quotes"),M),this._requesters.quotes.update.subscribe(this,this._onQuotesUpdate),this._requesters.quotes.statusChanged.subscribe(this,this._onRequesterStatusUpdate)):this._requesters.quotes.changeUrl(t),this._requesters.quotes.start())}_stopRequester(t){void 0!==t&&(t.stop(),t.update.unsubscribeAll(this))}async _requestExecutions(t){this._fetchedBrokerSymbols.add(t);const e=await O(this._getExecutionsUrl(t),g.Get,this._getHeaders(),null,M),s=Object(h.c)(this._restExecutions,e,"id",["id"]);for(const t of s.added){this._restExecutions.push(t);const e=await this._executionToTv(t);this._tvExecutions.push(e),this._host.executionUpdate(e)}}_createMapper(){this._mapper=this._host.createMapperSync(this._metainfo.id,this.unhideSymbolSearchGroups())}async _requestExecutionsBySymbols(t){await Promise.all(t.map((t=>this._requestExecutions(t))))}_setAccountSummaryRowData(t){const e=t.hasOwnProperty("equity")&&void 0!==t.equity?t.equity:t.balance+t.unrealizedPl;if(this._ensuredConfigFlags().supportCustomAccountSummaryRow){const e=Object(i.ensureDefined)(t.accountSummaryRowData);for(let t=0;t<e.length;t++)this._accountSummaryRowData.values[t].setValue(e[t])}else this._accountSummaryRowData.values[0].setValue(t.balance),this._accountSummaryRowData.values[1].setValue(e),this._accountSummaryRowData.values[2].setValue(t.unrealizedPl);isFinite(e)&&this._host.equityUpdate(e)}_setAccountManagerTableData(t){if(0!==this._accountManagerTablesData.length)for(let e=0;e<t.length;e++){const s=t[e],r=this._accountManagerTablesData[e],o=Object(i.ensure)(this._brokerConfig.accountManager)[e].columns;r.length=s.length;for(let t=0;t<s.length;t++){const n=s[t],a={id:t};for(let t=0;t<n.length;t++)a[Object(i.ensure)(o[t].id)]=n[t];r[t]=a,this._accountManagerTablesDelegates[e].fire(a)}}}async _createRequesters(){const t=this._getOrdersRestUrl(),e=this._getAccountStateRestUrl();if(this._requesters={orders:new C(t,g.Get,this._getHeaders(),null,this._getPullingInterval("orders"),"id",q,M,void 0,!0),accountState:new w(e,g.Get,this._getHeaders(),null,this._getPullingInterval("accountManager"),M)},this._ensuredConfigFlags().supportPositions){const t=this._getPositionsRestUrl(),e=new C(t,g.Get,this._getHeaders(),null,this._getPullingInterval("positions"),"id",D,M);e.update.subscribe(this,this._onPositionsUpdate),e.statusChanged.subscribe(this,this._onRequesterStatusUpdate),this._requesters.positions=e}if(this._ensuredConfigFlags().supportBalances){const t=this._getBalancesRestUrl(),e=new w(t,g.Get,this._getHeaders(),null,this._getPullingInterval("balances"),M);e.update.subscribe(this,this._onCryptoBalancesUpdate),e.statusChanged.subscribe(this,this._onRequesterStatusUpdate),this._requesters.balances=e}const s=Object(i.ensure)(this._requesters.orders);s.update.subscribe(this,this._onOrdersUpdate),s.statusChanged.subscribe(this,this._onRequesterStatusUpdate),Object(i.ensure)(this._requesters.accountState).update.subscribe(this,this._onAccountStateUpdate)}async _startRequesters(){const t=[];Object.keys(this._requesters).forEach((e=>t.push(Object(i.ensure)(this._requesters[e]).start()))),await Promise.all(t),this._logger.logInfo("Requesters started")}_stopAndDeleteRequesters(){Object.keys(this._requesters).forEach((t=>{const e=this._requesters[t];void 0!==e&&this._stopRequester(e)})),this._requesters={}}_changeRequestersHeaders(){Object.keys(this._requesters).forEach((t=>{const e=Object(i.ensure)(this._requesters[t]);e.pause(),e.changeHeaders(this._getHeaders()),e.unpause()}))}_cleanup(){this._stopAndDeleteRequesters(),this._initData()}_setStatus(t,e){this._status.value()!==t&&(this._status.setValue(t),this._host.connectionStatusUpdate(t,e))}_onRequesterStatusUpdate(t){2===t.requesterStatus&&(this._reconnectOnFailCount<=3?(this._logger.logError(`Requester error: ${t.errorMessage}. Reconnecting count: ${this._reconnectOnFailCount++} of 3.`),this._setStatus(4,{message:t.errorMessage}),this._disconnect(!0),this._tryReconnect()):(this._logger.logError(`Requester error: ${t.errorMessage}. Maximum reconnect count reached. Disconnecting.`),this._setStatus(3,{message:t.errorMessage,disconnectType:n.b.FailedRestoring}),this._disconnect(!1)))}_onAccountStateUpdate(t){this._setAccountSummaryRowData(t);const e=$(t);this._setAccountManagerTableData(e)}_onCryptoBalancesUpdate(t){const e=Object(h.c)(this._cryptoBalances,t,"symbol",I);[...e.added,...e.modified].forEach((t=>{const e=this._cryptoBalanceIndexBySymbol(t.symbol);-1!==e?this._cryptoBalances[e]=t:this._cryptoBalances.push(t);const s=H(t);this._cryptoBalanceTableChangeDelegate.fire(s),this._host.cryptoBalanceUpdate(t.symbol,t)})),e.removed.forEach((t=>{const e=this._cryptoBalanceIndexBySymbol(t.symbol);if(-1!==e){const s=0,r=0,i=0,o=Object.assign({},t,{total:s,available:r,btcValue:i});this._cryptoBalances[e]=o;const n=H(o);this._cryptoBalanceTableChangeDelegate.fire(n)}}))}_cryptoBalanceIndexBySymbol(t){return this._cryptoBalances.findIndex((e=>e.symbol===t))}async _tryConnect(){const t=this._getStoredAuthResult();t&&(this._accessToken=t.access_token,this._setStatus(2),await this._setAndStartLoginTasks(),this._setAccessTokenExpirationTimeout(t.expiration),this._createButtonDropdownOptions(),this._setStatus(1))}async _tryReconnect(){try{await this._tryConnect()}catch(t){this._logger.logError(Object(d.c)(t)),this._setStatus(3,{message:Object(d.b)(t),disconnectType:n.b.FailedRestoring}),this._disconnect()}}async _tryRestorePreviousSession(){try{await this._tryConnect()}catch(t){const e=Object(d.b)(t);this._logger.logNormal("Cannot restore session: "+e),this._setStatus(3,{message:void 0,disconnectType:n.b.FailedRestoring}),this._disconnect()}}_mergeCustomFieldColumns(t,e){const s=t.slice(),r=t.map((t=>t.property));for(const t of e){if(t.id in r){this._logger.logWarn(`Failed to add custom column. Column with id ${t.id} already exists.`);continue}const{id:e,title:o,tooltip:n,alignment:a}=t,c={label:o,property:e,help:n,notSortable:!0};void 0!==a&&(Object(i.assert)(["left","right"].includes(a),"Cell alignment must be left or right"),c.alignment=a),s.splice(-1,0,c)}return s}_authorizeRequestTwoFactorCode(t,e){return async function(t,e,s){return f(t,void 0,g.Post,Object.assign(Object.assign({},y(e,s)),{twoFactorRequired:!0}))}(this._getAuthorizeUrl(),t,e)}_authorizeWithTwoFactorCode(t,e,s){return async function(t,e,s,r){return f(t,void 0,g.Post,Object.assign(Object.assign({},y(e,s)),{twoFactorCode:r}))}(this._getAuthorizeUrl(),t,e,s)}async _authorize(t,e){return async function(t,e,s){return f(t,void 0,g.Post,Object.assign({},y(e,s)))}(this._getAuthorizeUrl(),t,e)}async _getInstrumentsByAccountId(t){return f(this._getInstrumentsUrlByAccountId(t),this._getAccessToken())}async _getOrdersHistoryByAccountId(t){return f(this._getOrdersHistoryUrlByAccountId(t),this._getAccessToken())}async _getPermittedSymbolSearchGroups(){const t=await f(this._getPermissionsUrl(),this._getAccessToken());return t.hasOwnProperty("groups")?t.groups:this._metainfo.id}async _getBrokerConfig(){const t=await f(this._getBrokerConfigUrl(),this._getAccessToken());if(null===t)throw new d.a({detailedErrorMessage:J+": Response is null",userFriendlyMessage:J});return L(t)||(t.accountManager=[{id:"accountSummary",title:"",columns:[{id:"balance",title:Object(r.t)("Balance"),tooltip:"",fixedWidth:!0,sortable:!1},{id:"equity",title:Object(r.t)("Equity"),tooltip:"",fixedWidth:!0,sortable:!1},{id:"profit",title:Object(r.t)("Profit"),tooltip:"",fixedWidth:!0,sortable:!1}]}]),t}async _getAccountState(){return f(this._getAccountStateUrl(),this._getAccessToken())}_placeOrder(t,e,s,r){const i=this._orderFromTV(t),o=this._getOrdersRestUrl()+"?requestId="+Object(P.randomHashN)(10);i.confirmId=r,null!==e&&(i.digitalSignature=e);const n=Object.assign(s,i);return f(o,this._getAccessToken(),g.Post,n)}async _modifyOrder(t,e,s,r){const i={id:t.id,qty:t.qty};t.parent||(t.stopLoss&&(i.stopLoss=t.stopLoss),t.takeProfit&&(i.takeProfit=t.takeProfit)),void 0!==t.duration&&(i.durationType=t.duration.type,void 0!==t.duration.datetime&&(i.durationDateTime=Math.trunc(t.duration.datetime/1e3)));const o=this._currentQuotes.get(t.symbol);void 0!==o&&(i.currentAsk=o.ask,i.currentBid=o.bid),i.limitPrice=(t.type,t.limitPrice),i.stopPrice=(t.type,t.stopPrice);const n=this._getOrderIdRestUrl(t.id);null!==e&&(i.digitalSignature=e);const a=Object.assign(s,i);return a.confirmId=r,f(n,this._getAccessToken(),g.Put,a)}async _modifySingleOrder(t,e){const s=this._ensuredConfigFlags().supportDigitalSignature,r=t.customFields&&t.customFields.digitalSignature?t.customFields.digitalSignature:this._getDigitalSignatureState(),i=s?r.text:null;null!==i&&this._setDigitalSignatureState(r);const o=Object.assign({},t.customFields);return delete o.digitalSignature,this._modifyOrder(t,i,o,e)}_createTvOrders(t){return t.map((t=>this._orderToTV(t)))}_onOrdersUpdate(t){const e=this._createTvOrders(t.added),s=this._createTvOrders(t.modified),r=[];this._restOrders.push(...t.added);for(const e of t.modified)this._restOrders[this._restOrderIndexById(e.id)]=e;this._tvOrders.push(...e),r.push(...e);for(const t of s)this._tvOrders[this._tvOrderIndexById(t.id)]=t,r.push(t);for(const t of r){if(1===t.parentType){const e=this._tvOrderById(t.parentId);e&&(Q(e,t),this._host.orderUpdate(e))}else if(2===t.parentType){const e=this._tvPositionById(t.parentId);if(e&&e.qty>0){Q(e,t);const s=e.stopLoss,r=e.takeProfit;this._host.positionPartialUpdate(e.id,{stopLoss:s,takeProfit:r})}}else if(!t.parentType){const e=this._getOrderBrackets(t.id);e.stopLoss&&(t.stopLoss=e.stopLoss),e.takeProfit&&(t.takeProfit=e.takeProfit)}this._host.orderUpdate(t)}}_createTVPositions(t){return t.map((t=>this._positionToTV(t)))}async _onPositionsUpdate(t){const e=[],s=this._createTVPositions(t.added),r=this._createTVPositions(t.modified);for(const e of t.added)this._addOrModifyPosition(e,this._restPositions);for(const e of t.modified)this._restPositions[this._restPositionIndexById(e.id)]=e;for(const t of s)this._updatePriceFormatterCacheForSymbol(t.symbol),this._addOrModifyPosition(t,this._tvPositions),this._updatePositionBrackets(t),this._host.positionUpdate(t),this._host.plUpdate(t.id,t.unrealizedPl),e.push(Object(i.ensureDefined)(t.brokerSymbol));for(const t of r){const s=this._tvPositionById(t.id);if(void 0===s)return;this._updatePositionBrackets(t),this._host.positionUpdate(t),s.unrealizedPl!==t.unrealizedPl&&(this._host.plUpdate(t.id,t.unrealizedPl),this._host.positionPartialUpdate(t.id,{unrealizedPl:t.unrealizedPl})),s.side===t.side&&s.qty===t.qty||e.push(Object(i.ensureDefined)(t.brokerSymbol)),this._addOrModifyPosition(t,this._tvPositions)}t.removed.forEach((t=>{const s=this._tvPositionById(t.id);if(void 0===s)return;const r=this._restPositionById(t.id);s.qty=0,r.qty=0,e.push(Object(i.ensureDefined)(s.brokerSymbol)),this._host.positionUpdate(s)})),this._ensuredConfigFlags().supportExecutions&&await this._requestExecutionsBySymbols(e)}_updatePositionBrackets(t){this._findPositionBracketOrders(t.id).forEach((e=>Q(t,e)))}_addOrModifyPosition(t,e){const s=e.findIndex((e=>e.id===t.id));-1!==s?e[s]=t:e.push(t)}_restPositionIndexById(t){return this._restPositions.findIndex((e=>e.id===t))}_restPositionById(t){const e=this._restPositions.find((e=>e.id===t));if(!e)throw new Error("Cannot find REST position: "+t);return e}_restOrderIndexById(t){return this._restOrders.findIndex((e=>e.id===t))}_tvPositionById(t){return this._tvPositions.find((e=>e.id===t))}_tvOrderIndexById(t){return this._tvOrders.findIndex((e=>e.id===t))}_tvOrderById(t){const e=this._tvOrders.find((e=>e.id===t));if(!e)throw new Error("Cannot find TV order");return e}_getBaseRestUrl(){const t=this._account.value().id;return Object(i.assert)(!!t,"Unable to get base url - account is not properly initialized"),this._getBaseRestUrlByAccountId(t)}_getBaseRestUrlByAccountId(t){return this._restUrl+"accounts/"+encodeURIComponent(t)}_getAccountStateRestUrl(){return`${this._getBaseRestUrl()}/state?locale=${window.locale}`}_getExecutionsUrl(t){return this._getBaseRestUrl()+"/executions?instrument="+encodeURIComponent(t)}_getPullingInterval(t){let e=B[t];if(this._brokerConfig.hasOwnProperty("pullingInterval")&&void 0!==this._brokerConfig.pullingInterval){const s=this._brokerConfig.pullingInterval;s.hasOwnProperty(t)&&(e=s[t])}return e}_getAuthorizeUrl(){return this._restUrl+"authorize"}_getBrokerConfigUrl(){return`${this._restUrl}config?locale=${window.locale}`}_getAccountsUrl(){return`${this._restUrl}accounts?locale=${window.locale}`}_getAccountStateUrl(){return`${this._getBaseRestUrl()}/state?locale=${window.locale}`}_getQuotesUrl(){const t=Array.from(this._quotesSubscriptions.keys()).filter((t=>this._instruments.has(t)));return 0===t.length?null:`${this._restUrl}quotes?symbols=${encodeURIComponent(t.join(","))}&accountId=${encodeURIComponent(this._account.value().id)}`}_getDepthUrl(t){return`${this._restUrl}depth?symbol=${encodeURIComponent(t)}&accountId=${encodeURIComponent(this._account.value().id)}`}_getInstrumentsUrlByAccountId(t){return`${this._getBaseRestUrlByAccountId(t)}/instruments?locale=${window.locale}`}_getOrdersHistoryUrlByAccountId(t){return this._getBaseRestUrlByAccountId(t)+"/ordersHistory?maxCount=200"}_getPermissionsUrl(){return this._restUrl+"permissions"}_getOrdersRestUrl(){return this._getBaseRestUrl()+"/orders"}_getOrderIdRestUrl(t){return this._getBaseRestUrl()+"/orders/"+t}_getPositionsRestUrl(){return this._getBaseRestUrl()+"/positions"}_getPositionIdRestUrl(t){return this._getBaseRestUrl()+"/positions/"+t}_getBalancesRestUrl(){return this._getBaseRestUrl()+"/balances"}_getOrderPreviewRestUrl(){return this._getBaseRestUrl()+"/previewOrder?locale="+window.locale}_getHeaders(){return m(this._getAccessToken())}_orderToTV(t){const e=this._mapToTV(t.instrument);null===e&&this._logger.logWarn("Cannot map symbol: "+t.instrument);const s={id:t.id,type:z(t.type),side:V(t.side),symbol:e||t.instrument,brokerSymbol:t.instrument,qty:Math.abs(t.qty),filledQty:t.filledQty,status:(r=t.status,x[r]),avgPrice:t.avgPrice,limitPrice:t.limitPrice,stopPrice:t.stopPrice};var r;if(t.parentId&&(s.parentId=t.parentId,s.parentType=this._getOrderParentType(t.parentType)),t.stopLoss&&(s.stopLoss=t.stopLoss),t.takeProfit&&(s.takeProfit=t.takeProfit),t.duration){s.duration={type:t.duration.type};const e=this._getOrderDuration(t.duration);if(Object(i.assert)(void 0!==e,"Order duration is not in durations list. Please check the broker or account duration configuration"),s.expiry=void 0!==e?e.title:t.duration.type,t.duration.hasOwnProperty("datetime")&&void 0!==t.duration.datetime){const r=1e3*t.duration.datetime;s.duration.datetime=r,s.expiryTime={dateOrDateTime:r,hasTime:Object(i.ensureDefined)(e).hasTimePicker}}}return void 0!==t.message&&(Object(h.f)(t.message.type)?s.message=t.message:this._logger.logError(`Order message type '${t.message.type}' is not supported`)),void 0!==t.lastModified&&(s.updateTime=1e3*t.lastModified),this._mergeCustomFields(t,s),s}_mergeCustomFields(t,e){if(void 0!==t.customFields)for(const s of t.customFields)e[s.id]=s.value}_getOrderParentType(t){return"position"===t?2:1}_getOrderDuration(t){return Object(i.ensureDefined)(this._brokerConfig.durations).find((e=>e.id===Object(i.ensureDefined)(t).type))}_orderFromTV(t){const e=this._mapFromTV(t.symbol);if(null!==e){const i={instrument:e,qty:t.qty,side:(r=t.side,-1===r?"sell":"buy"),type:(s=t.type,A[s=s||2]),limitPrice:t.limitPrice,stopPrice:t.stopPrice};t.stopLoss&&(i.stopLoss=t.stopLoss),t.takeProfit&&(i.takeProfit=t.takeProfit),t.duration&&(i.durationType=t.duration.type,t.duration.datetime&&(i.durationDateTime=Math.trunc(t.duration.datetime/1e3)));const o=this._currentQuotes.get(t.symbol);return void 0!==o&&(i.currentAsk=o.ask,i.currentBid=o.bid),i}throw new Error("Cannot map symbol: "+t.symbol);var s,r}_getOrderBrackets(t){const e=this._tvOrders.filter((e=>1===e.parentType&&e.parentId===t&&1!==e.status)),s={};for(const t of e)3===t.type&&(s.stopLoss=t.stopPrice),1===t.type&&(s.takeProfit=t.limitPrice);return s}_findPositionBracketOrders(t){return this._tvOrders.filter((e=>2===e.parentType&&e.parentId===t&&6===e.status))}_getPositionBracketsById(t){const e=this._findPositionBracketOrders(t),s={};for(const t of e)3===t.type&&(s.stopLoss=t.stopPrice),1===t.type&&(s.takeProfit=t.limitPrice);return s}_executionToTv(t){const e=this._mapToTV(t.instrument);return null===e&&this._logger.logWarn("Cannot map symbol: "+t.instrument),{id:t.id,symbol:e||"",brokerSymbol:t.instrument,price:t.price,qty:t.qty,side:V(t.side),time:1e3*t.time,orderId:t.orderId,isClose:t.isClose,positionId:t.positionId,commission:t.commission}}_positionToTV(t){const e=this._mapToTV(t.instrument);null===e&&this._logger.logWarn("Cannot map symbol: "+t.instrument);const s={id:t.id,symbol:e||t.instrument,brokerSymbol:t.instrument,qty:Math.abs(t.qty),side:"buy"===t.side?1:-1,avgPrice:t.avgPrice,unrealizedPl:t.unrealizedPl,realizedPl:t.realizedPl,currency:this._account.value().currency};return void 0!==t.message&&(Object(h.f)(t.message.type)?s.message=t.message:this._logger.logError(`Position message type '${t.message.type}' is not supported`)),this._ensuredConfigFlags().supportPartialOrderExecution&&(s.filledQty=t.filledQty),this._tvOrders.filter((t=>2===t.parentType&&t.parentId===s.id)).forEach((t=>Q(s,t))),this._mergeCustomFields(t,s),s}_mapToTV(t){return this._mapper.brokerToTv(t)}_mapFromTV(t){return this._mapper.tvToBroker(t)}_initData(){this._accountManagerTablesDelegates=[],this._accountManagerTablesData=[],this._restExecutions=[],this._tvExecutions=[],this._restOrders=[],this._tvOrders=[],this._restPositions=[],this._tvPositions=[],this._instruments.clear(),this._priceFormatterCache.clear(),this._currentQuotes.clear(),this._cryptoBalances=[],this._accountSummaryRowData={titles:[],values:[],formatters:[]}}_createButtonDropdownOptions(){const t=this._host.defaultDropdownMenuActions({tradingProperties:!0});this._host.setButtonDropdownActions(t)}async _initRequesters(){this._accounts.length>0&&(await this._createRequesters(),await this._startRequesters())}_getStoredAuthResult(){return this._host.credentialsStorage.load(this._tokenStorageKey)}_setAccessTokenExpirationTimeout(t){if(null===t)return;let e,s=this._checkAccessTokenExpiration.bind(this);e=1e3*Object(i.ensureDefined)(t)-Date.now().valueOf(),e<0?this._checkAccessTokenExpiration():(s=this._checkAccessTokenExpiration.bind(this),e+=1e4,this._accessTokenExpirationTimeout=setTimeout(s,e))}_saveAccessToken(t){this._host.credentialsStorage.save(this._tokenStorageKey,t),this._accessToken=t.access_token}_checkAccessTokenExpiration(){const t=this._getStoredAuthResult();if(t&&1e3*Object(i.ensureNotNull)(t.expiration)<=Date.now().valueOf()){const t=Object(r.t)("Access token has expired");this._logger.logError(t),this._setStatus(4,{message:t,disconnectType:n.b.LogOut}),this._disconnect()}}_onDepthUpdate(t,e){const s={snapshot:!0,asks:W(e.asks),bids:W(e.bids)};this._host.domeUpdate(t,s)}_getAccountWithTradableSymbol(t){let e=null;for(const s of this._accounts)if(-1!==s.instruments.findIndex((e=>t===e.name))){e=s;break}return e}async _createPriceFormatter(t){try{if(await this._host.isFractional(t))return await this._host.defaultFormatter(t,!0);const e=this._mapFromTV(t);if(null===e)throw new Error("Symbol not found");const s=this._instruments.get(e);if(void 0===s)throw new Error("Instrument not found");const r=Math.pow(10,Object(h.g)(s.minTick)),i=s.minTick*r;return this._host.factory.createPriceFormatter(r,i,!1)}catch(e){return this._logger.logWarn(`Failed to create price formatter for symbol ${t}.`),this._host.factory.createPriceFormatter()}}async _getPriceFormatterForSymbol(t){let e=this._priceFormatterCache.get(t);return e||(e=await this._createPriceFormatter(t),this._priceFormatterCache.set(t,e)),e}async _updatePriceFormatterCacheForSymbol(t){if(!this._priceFormatterCache.has(t)){this._priceFormatterCache.set(t,null);const e=await this._createPriceFormatter(t);this._priceFormatterCache.set(t,e),this._tvPositions.filter((e=>e.symbol===t&&e.qty>0)).forEach((t=>this._host.positionUpdate(t)))}}_getAccountById(t){return this._accounts.find((e=>e.id===t))}_saveAccountId(t){this._host.settings.save(this._lastAccountIdKey,JSON.stringify(t.id))}_getLastAccount(){const t=this._host.settings.load(this._lastAccountIdKey,void 0);return void 0!==t?this._getAccountById(JSON.parse(t)):void 0}_isTwoFactorAuthorizationType(){return"password"===this._ensuredConfigFlags().authorizationType&&Boolean(this._ensuredConfigFlags().supportTwoFactorAuthorization)}_isSimplePasswordAuthorizationType(){return"password"===this._ensuredConfigFlags().authorizationType&&!this._ensuredConfigFlags().supportTwoFactorAuthorization}_isOAuthAuthorizationType(){return this._isOAuthCodeFlowAuthType()||this._isOAuthImplicitFlowAuthType()}_isOAuthImplicitFlowAuthType(){return"oauth2-implicit-flow"===this._ensuredConfigFlags().authorizationType}_isOAuthCodeFlowAuthType(){return"oauth2-code-flow"===this._ensuredConfigFlags().authorizationType}_makeDigitalSignatureCustomField(){return{inputType:"TextWithCheckBox",id:"digitalSignature",title:Object(r.t)("Digital Signature"),placeHolder:Object(r.t)("Enter your personal digital signature"),value:this._getDigitalSignatureState(),customInfo:{checkboxTitle:Object(r.t)("Save"),asterix:!0}}}_setDigitalSignatureState(t){const e=t.checked?t:R;this._host.credentialsStorage.save("digital-signature-state",e)}_getDigitalSignatureState(){const t=this._host.credentialsStorage.load("digital-signature-state");return null!==t?t:R}_makeAccountSummaryRowData(){let t=[],e=[];const s=[];if(this._ensuredConfigFlags().supportCustomAccountSummaryRow&&void 0!==this._brokerConfig.accountSummaryRow)for(const r of this._brokerConfig.accountSummaryRow)t.push(r.title),e.push(this._host.factory.createWatchedValue()),s.push("default");else t=[Object(r.t)("Account Balance"),Object(r.t)("Equity",{context:"trading"}),Object(r.t)("Profit")],e=[this._host.factory.createWatchedValue(),this._host.factory.createWatchedValue(),this._host.factory.createWatchedValue()],s.fill("fixed",0,2);this._accountSummaryRowData.titles=t,this._accountSummaryRowData.values=e,this._accountSummaryRowData.formatters=s}_cleanAccessTokenExpirationTimeout(){null!==this._accessTokenExpirationTimeout&&(clearTimeout(this._accessTokenExpirationTimeout),this._accessTokenExpirationTimeout=null)}_cleanAndDestroyOauthAuthorizationProvider(){null!==this._oAuthAuthorizationProvider&&(this._oAuthAuthorizationProvider.renewTokenDelegate().unsubscribe(this,this._onRenewAccessTokenHandler),this._oAuthAuthorizationProvider.destroy(),this._oAuthAuthorizationProvider=null)}_onRenewAccessTokenHandler(t){if(null===t)return this._setStatus(3),void this._disconnect();this._saveAccessToken(t),this._changeRequestersHeaders()}_ensuredConfigFlags(){return Object(i.ensureDefined)(this._metainfo.configFlags)}_makeAccountOrderDialogCustomFields(t){var e,s;return(null===(s=null===(e=t.ui)||void 0===e?void 0:e.orderDialogCustomFields)||void 0===s?void 0:s.comboBox)?G(t.ui.orderDialogCustomFields.comboBox):[]}_makeInstrumentOrderDialogCustomFields(t){var e,s;const r=this._mapFromTV(t);if(null===r)return[];const i=null===(s=null===(e=this._instruments.get(r))||void 0===e?void 0:e.ui)||void 0===s?void 0:s.orderDialogCustomFields;return void 0!==i?G(i.comboBox):[]}_makeOrderDialogCustomFields(t){const e=this._makeInstrumentOrderDialogCustomFieldsMemoized(t),s=this._makeAccountOrderDialogCustomFieldsMemoized(this._account.value()),r=[...e.length>0?e:s];return this._ensuredConfigFlags().supportDigitalSignature&&r.push(this._makeDigitalSignatureCustomField()),r}}}}]);